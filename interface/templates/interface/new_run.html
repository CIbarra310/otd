{% extends 'interface/layout.html' %}
{% load crispy_forms_tags %}

{% block content %}
<nav class="p-2" aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Dashboard</a></li>
        <li class="breadcrumb-item active" aria-current="page">New Run</li>
    </ol>
</nav>
<main>
    <div class="run-request-container shadow-md col-6 col-md-6 col-lg-4 col-xl-4">
        <div class="card-body">
            <h2 class="text-center">Create New Run</h2>
            <hr>
            <form method="POST" autocomplete="off" action="{% url 'new_run' %}" enctype="multipart/form-data">
                {% csrf_token %}
                <!-- Hidden contact information -->
                <div class="row" hidden>
                    <h5>Contact Information</h5>
                    <div class="col-6">
                        <label>Name</label>
                        <input type="text" class="form-control" name="requester_name" value="{{ run.requester_name.value }}">
                    </div>
                    <div class="col-6">
                        <label>Department</label>
                        <input type="text" class="form-control" name="requester_department" value="{{ request.session.department }}">
                    </div>
                    <div class="col-6">
                        <label>Email</label>
                        <input type="text" class="form-control" name="requester_email" value="{{ request.session.email }}">
                    </div>
                    <div class="col-6">
                        <label>Phone</label>
                        <input type="text" class="form-control" name="requester_phone" value="{{ request.session.phone_number }}">
                    </div>
                    <div class="col-6">
                        <label>Production</label>
                        <input type="text" class="form-control" name="production_title" value="{{ request.session.production_title }}">
                    </div>
                </div>
                <!-- Date/Time Information -->
                <div class="row" id="step1">
                    <h5>Date/Time Information</h5>
                    <div class="col-12">
                        <label for="run_date">Date:</label>
                        <input type="date" class="form-control run-request-input" name="run_date" id="run_date">
                    </div>
                    <div class="col-6">
                        <label for="ready_time">Ready Time:</label>
                        <input type="time" class="form-control run-request-input" name="ready_time" id="ready_time">
                    </div>
                    <div class="col-6">
                        <label for="need_by_this_time">Need By:</label>
                        <input type="time" class="form-control run-request-input" name="need_by_this_time" id="need_by_this_time">
                    </div>
                    <div class="next-button-box">
                        <br>
                        <button type="button" class="btn btn-primary next-button">Next</button>
                    </div>
                </div>
                <!-- Get pickup location -->
                <div class="row" id="step2" hidden>
                    <h5>Where are we going?</h5>
                    <div class="col-12">
                        <label>Pick Up From</label>
                        <input type="text" class="form-control run-request-input" name="pickup_name" id="pickup-search-input" placeholder="Search for location">
                        <ul id="pickup-search-results" class="list-group"></ul>
                    </div>
                    <div class="col-12">
                        <label>Address 1</label>
                        <input type="text" class="form-control run-request-input" name="pickup_address_1" placeholder="123 Main St.">
                    </div>
                    <div class="col-12">
                        <label>Address 2</label>
                        <input type="text" class="form-control run-request-input" name="pickup_address_2" placeholder="Unit/Ste.">
                    </div>
                    <div class="col-5">
                        <label>City</label>
                        <input type="text" class="form-control run-request-input" name="pickup_city" placeholder="Culver City">
                    </div>
                    <div class="col-3">
                        <label>State</label>
                        <input type="text" class="form-control run-request-input" name="pickup_state" placeholder="CA">
                    </div>
                    <div class="col-4">
                        <label>Zip</label>
                        <input type="text" class="form-control run-request-input" name="pickup_zip" placeholder="90232">
                    </div>
                    <div class="next-button-box">
                        <br>
                        <button type="button" class="btn btn-secondary back-button">Back</button>
                        <button type="button" class="btn btn-primary next-button">Next</button>
                    </div>
                </div>
                <!-- Get run details -->
                <div class="row" id="step3" hidden>
                    <h5>What are we getting?</h5>
                    <div class="col-12 mb-3">
                        <label for="run_details" class="form-label">Run Details</label>
                        <textarea class="form-control" name="run_details" id="run_details" rows="6"></textarea>
                    </div>
                    <div class="next-button-box">
                        <br>
                        <button type="button" class="btn btn-secondary back-button">Back</button>
                        <button type="button" class="btn btn-primary next-button">Next</button>
                    </div>
                </div>
                <!-- Get drop off location -->
                <div class="row" id="step4" hidden>
                    <h5>Where are we taking the item(s)?</h5>
                    <div class="col-12">
                        <label>Drop Off</label>
                        <input type="text" class="form-control run-request-input" name="dropoff_name" id="dropoff-search-input" placeholder="Search for location">
                        <ul id="dropoff-search-results" class="list-group"></ul>
                    </div>
                    <div class="col-12">
                        <label>Address 1</label>
                        <input type="text" class="form-control run-request-input" name="dropoff_address_1" placeholder="10202 Washington Blvd">
                    </div>
                    <div class="col-12">
                        <label>Address 2</label>
                        <input type="text" class="form-control run-request-input" name="dropoff_address_2" placeholder="Stage 21">
                    </div>
                    <div class="col-5">
                        <label>City</label>
                        <input type="text" class="form-control run-request-input" name="dropoff_city" placeholder="Culver City">
                    </div>
                    <div class="col-3">
                        <label>State</label>
                        <input type="text" class="form-control run-request-input" name="dropoff_state" placeholder="CA">
                    </div>
                    <div class="col-4">
                        <label>Zip</label>
                        <input type="text" class="form-control run-request-input" name="dropoff_zip" placeholder="90232">
                    </div>
                    <div class="next-button-box">
                        <br>
                        <button type="button" class="btn btn-secondary back-button">Back</button>
                        <button type="button" class="btn btn-primary next-button">Next</button>
                    </div>
                </div>   
                <!-- Additional information -->        
                <div class="row" id="step5" hidden>
                    <h5>Additonal Information</h5>
                    <div class="col-12">
                        <div class="col-12 mb-3">
                            <label for="truck_size">Truck Size</label>
                            <select class="form-control run-request-input" name="truck_size" id="truck_size">
                                <option value="" disabled selected>Select a truck size</option>
                                <option value="Passenger Van">Passenger Van</option>
                                <option value="Stakebed">Stakebed</option>
                                <option value="Cube Truck">Cube Truck</option>
                                <option value="5-Ton">5-Ton</option>
                                <option value="10-Ton">10-Ton</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <label>P.O. #</label>
                        <input type="text" class="form-control run-request-input" name="purchase_order" placeholder="1234">
                    </div>
                    <div class="col-6 mb-3">
                        <label>Vendor Order #</label>
                        <input type="text" class="form-control run-request-input" name="vendor_invoice" placeholder="1234">
                    </div>
                    <div class="col-12 mb-3">
                        <label for="formFileSm" class="form-label">Supporting Documents</label>
                        <input class="form-control form-control-sm" id="formFileSm" type="file">
                    </div>
                    <div class="next-button-box">
                        <br>
                        <button type="button" class="btn btn-secondary back-button">Back</button>
                        <button type="submit" class="btn btn-primary next-button">Submit Run Request</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            function showStep(step) {
                const steps = ['step1', 'step2', 'step3', 'step4', 'step5'];
                steps.forEach(s => document.getElementById(s).hidden = s !== step);
            }
            document.querySelector('#step1 .next-button').addEventListener('click', function() {
                showStep('step2');
            });
            document.querySelector('#step2 .back-button').addEventListener('click', function() {
                showStep('step1');
            });
            document.querySelector('#step2 .next-button').addEventListener('click', function() {
                showStep('step3');
            });
            document.querySelector('#step3 .back-button').addEventListener('click', function() {
                showStep('step2');
            });
            document.querySelector('#step3 .next-button').addEventListener('click', function() {
                showStep('step4');
            });
            document.querySelector('#step4 .back-button').addEventListener('click', function() {
                showStep('step3');
            });
            document.querySelector('#step4 .next-button').addEventListener('click', function() {
                showStep('step5');
            });
            document.querySelector('#step5 .back-button').addEventListener('click', function() {
                showStep('step4');
            });
        });
    </script>
</main>

<!-- Script for the live search -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const pickupSearchInput = document.getElementById('pickup-search-input');
    const dropoffSearchInput = document.getElementById('dropoff-search-input');
    const pickupSearchResults = document.getElementById('pickup-search-results');
    const dropoffSearchResults = document.getElementById('dropoff-search-results');

    pickupSearchInput.addEventListener('input', function() {
        const inputValue = pickupSearchInput.value.trim();
        if (inputValue.length > 0) {
            fetchLocations(inputValue, 'pickup');
        } else {
            pickupSearchResults.innerHTML = ''; // Clear results if input is empty
        }
    });

    dropoffSearchInput.addEventListener('input', function() {
        const inputValue = dropoffSearchInput.value.trim();
        if (inputValue.length > 0) {
            fetchLocations(inputValue, 'dropoff');
        } else {
            dropoffSearchResults.innerHTML = ''; // Clear results if input is empty
        }
    });

    pickupSearchResults.addEventListener('click', function(event) {
        if (event.target && event.target.nodeName === 'LI') {
            const selectedData = JSON.parse(event.target.getAttribute('data-item'));
            populateFormFields(selectedData);
            pickupSearchResults.innerHTML = ''; // Clear results after selection
        }
    });

    dropoffSearchResults.addEventListener('click', function(event) {
        if (event.target && event.target.nodeName === 'LI') {
            const selectedData = JSON.parse(event.target.getAttribute('data-item'));
            populateFormFields(selectedData);
            dropoffSearchResults.innerHTML = ''; // Clear results after selection
        }
    });

    function fetchLocations(query, type) {
        fetch(`/search_locations/?query=${query}&type=${type}`)
        .then(response => response.json())
        .then(data => {
            if (type === 'pickup') {
                displaySearchResults(data, pickupSearchResults);
            } else if (type === 'dropoff') {
                displaySearchResults(data, dropoffSearchResults);
            }
        })
        .catch(error => {
            console.error('Error fetching locations:', error);
        });
    }

    function displaySearchResults(data, resultElement) {
        resultElement.innerHTML = '';
        data.forEach(item => {
            const li = document.createElement('li');
            li.classList.add('list-group-item');
            li.textContent = `${item.type === 'vendor' ? '' : 'Production Location: '}${item.name}`;
            li.setAttribute('data-item', JSON.stringify(item));
            resultElement.appendChild(li);
        });
    }

    function populateFormFields(data) {
        if (data.search_type === 'pickup') {
            document.querySelector('input[name="pickup_name"]').value = data.name;
            document.querySelector('input[name="pickup_address_1"]').value = data.address_1;
            document.querySelector('input[name="pickup_address_2"]').value = data.address_2 || '';
            document.querySelector('input[name="pickup_city"]').value = data.city;
            document.querySelector('input[name="pickup_state"]').value = data.state;
            document.querySelector('input[name="pickup_zip"]').value = data.zip;
        } else if (data.search_type === 'dropoff') {
            document.querySelector('input[name="dropoff_name"]').value = data.name;
            document.querySelector('input[name="dropoff_address_1"]').value = data.address_1;
            document.querySelector('input[name="dropoff_address_2"]').value = data.address_2 || '';
            document.querySelector('input[name="dropoff_city"]').value = data.city;
            document.querySelector('input[name="dropoff_state"]').value = data.state;
            document.querySelector('input[name="dropoff_zip"]').value = data.zip;
        }
    }
});

</script>
    
{% endblock %}